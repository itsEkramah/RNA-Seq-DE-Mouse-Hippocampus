# #Differential Expression Analysis (R/DESeq2) for Interactive Use in RStudio

cd /media/ekramah/DISK2/RNASEQ2/07_scripts/
cat << 'EOF' > DE_analysis_Rstudio.R
# DE_analysis_Rstudio.R
# This R script performs Differential Expression (DE) analysis using DESeq2
# and generates various diagnostic and visualization plots.
# It is designed for interactive use within RStudio.
#
# To run this script:
# 1. Open RStudio.
# 2. Set your working directory to the main project folder (e.g., Session -> Set Working Directory -> Choose Directory...).
#    Example: setwd("/media/ekramah/DISK2/RNASEQ2")
# 3. Install any missing packages (uncomment the relevant lines below and run them once).
# 4. Run the script line by line or in chunks.

# Clear workspace: Useful for starting with a clean environment in RStudio
rm(list=ls())

# --- Install and Load Necessary Libraries ---
# If you encounter an error about a missing package when running 'library()',
# uncomment the relevant `install.packages()` or `BiocManager::install()`
# line below and run it once from your RStudio console.

# BiocManager is required for many bioinformatics packages
# if (!requireNamespace("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")

# Install core DESeq2 and plotting packages
# BiocManager::install("DESeq2", update = FALSE, ask = FALSE)
# install.packages("ggplot2")
# install.packages("dplyr")
# BiocManager::install("EnhancedVolcano", update = FALSE, ask = FALSE)
# install.packages("pheatmap")
# install.packages("RColorBrewer")

# Load the libraries into the current R session
library(DESeq2)
library(ggplot2)
library(dplyr)
library(EnhancedVolcano)
library(pheatmap)
library(RColorBrewer)

# --- Set working directory ---
# IMPORTANT: Ensure this path is correct for your system.
# It should be the root of your RNA-Seq project folder.
setwd("/media/ekramah/DISK2/RNASEQ2")
message(sprintf("Working directory set to: %s", getwd()))

# --- 1. Load Gene Counts Data ---
message("Loading gene counts data...")
# The gene_counts.txt file is generated by featureCounts in the 04_quantification directory.
count_data <- read.table("04_quantification/gene_counts.txt", header = TRUE, row.names = 1, stringsAsFactors = FALSE)
message(sprintf("Raw data loaded. Dimensions: %d rows, %d columns.", nrow(count_data), ncol(count_data)))

# Remove the first 6 metadata columns from featureCounts output
count_data <- count_data[, 7:ncol(count_data)]
message(sprintf("Data after removing metadata columns. Dimensions: %d rows, %d columns.", nrow(count_data), ncol(count_data)))

# --- Robust Column Name Cleaning ---
original_colnames <- colnames(count_data)
message("Original column names from featureCounts (before cleaning):")
print(original_colnames)

# Use a regular expression to extract only the "SRR" followed by 7 digits.
cleaned_colnames <- sub(".*(SRR[0-9]{7}).*", "\\1", original_colnames)

# Assign the cleaned names back to the count_data dataframe.
colnames(count_data) <- cleaned_colnames
message("Cleaned column names:")
print(colnames(count_data))

# Check for duplicate sample names after cleaning. Row names in R data frames must be unique.
if (any(duplicated(colnames(count_data)))) {
  stop("CRITICAL ERROR: Duplicate sample names found after cleaning column names. Please check your featureCounts output and naming convention.")
}
message("No duplicates found in cleaned column names. Proceeding...")

# Ensure count data is in integer mode. DESeq2 requires integer counts.
count_data <- round(count_data)
message("Count data rounded to integers.")


# --- 2. Create Sample Metadata (colData) ---
sample_names_in_counts <- colnames(count_data)

# Define a mapping from sample accession to its experimental condition.
# This list must EXACTLY match the samples you downloaded and processed.
conditions_map <- data.frame(
  sample = c("SRR7498002", "SRR7498004", "SRR7498006", "SRR7498008", "SRR7498010", # WildType samples
             "SRR7498016", "SRR7498018", "SRR7498020", "SRR7498022", "SRR7498024"), # Notch2CKO samples
  condition = c(rep("WildType", 5), rep("Notch2CKO", 5)) # 5 WildType, 5 Notch2 CKO replicates
)
message("Conditions map defined.")
message("Expected samples in conditions_map:")
print(conditions_map$sample)

# Create colData by matching samples from count_data to conditions_map.
message("Attempting to create colData using match...")
match_indices <- match(sample_names_in_counts, conditions_map$sample)
message("Result of match (indices):")
print(match_indices)

# Check for NAs in match_indices. NA means a sample from count_data was not found in conditions_map.
if (any(is.na(match_indices))) {
  missing_samples <- sample_names_in_counts[is.na(match_indices)]
  stop(sprintf("CRITICAL ERROR: The following samples from your count data were not found in your conditions_map: %s. Please ensure exact matching.", paste(missing_samples, collapse=", ")))
}

colData <- conditions_map[match_indices, ]
message("colData created before setting row names. colData$sample values:")
print(colData$sample)

# Final check for duplicates in colData$sample before assigning to row names.
if (any(duplicated(colData$sample))) {
  duplicated_values <- colData$sample[duplicated(colData$sample)]
  stop(sprintf("CRITICAL ERROR: Duplicate values found in colData$sample before assigning row names: %s. This indicates an issue with sample name uniqueness after matching.", paste(duplicated_values, collapse=", ")))
}

rownames(colData) <- colData$sample
message("colData row names set successfully.")

if (any(is.na(colData$condition))) {
  stop("Error: Not all samples in colData have a valid condition after matching.")
}
message("colData created successfully.")

colData$condition <- factor(colData$condition)
colData$condition <- relevel(colData$condition, ref = "WildType")
message("Conditions set as factors with 'WildType' as reference.")


# --- 3. Construct DESeqDataSet object ---
message("Constructing DESeqDataSet object...")
dds <- DESeqDataSetFromMatrix(countData = count_data,
                              colData = colData,
                              design = ~ condition)
message("DESeqDataSet object created.")

# --- 4. Pre-filtering: Remove genes with very low counts ---
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
message(sprintf("Retained %d genes after filtering (out of %d total).", nrow(dds), nrow(count_data)))

# --- 5. Run DESeq2 analysis ---
message("Running DESeq analysis (normalization, dispersion estimation, and testing)...")
dds <- DESeq(dds)
message("DESeq2 analysis completed.")

message("Available coefficients for lfcShrink (resultsNames(dds)):")
print(resultsNames(dds))

# --- 6. Get results ---
message("Extracting results...")
res <- results(dds, contrast=c("condition","Notch2CKO","WildType"))

lfc_coeff_name <- "condition_Notch2CKO_vs_WildType"
message(sprintf("Applying apeglm shrinkage using coefficient: %s", lfc_coeff_name))
res <- lfcShrink(dds, coef=lfc_coeff_name, res=res, type="apeglm")

res_ordered <- res[order(res$padj),]

res_df <- as.data.frame(res_ordered)
res_df$gene <- rownames(res_df)
res_df$is_significant <- ifelse(res_df$padj < 0.05 & abs(res_df$log2FoldChange) >= 1, "Yes", "No")
message(sprintf("Found %d significantly differentially expressed genes (padj < 0.05 and |log2FC| >= 1).", sum(res_df$is_significant == "Yes", na.rm = TRUE)))

# --- 7. Save results ---
write.csv(res_df, "05_DE_analysis/deseq2_results.csv", row.names = TRUE)
message("DESeq2 results saved to 05_DE_analysis/deseq2_results.csv")

# --- 8. Exploratory Data Analysis (EDA) and Visualization ---
message("Generating plots...")

# --- A. Dispersion Plot ---
pdf("05_DE_analysis/dispersion_plot.pdf")
plotDispEsts(dds)
mtext("Dispersion Estimates", side = 3, line = 1.5)
dev.off()
message("Dispersion plot saved to 05_DE_analysis/dispersion_plot.pdf")

# --- B. MA Plot ---
pdf("05_DE_analysis/MA_plot.pdf")
plotMA(res, ylim=c(-5,5), main="MA Plot (Notch2CKO vs WildType)")
abline(h=c(-1,1), col="blue")
dev.off()
message("MA plot saved to 05_DE_analysis/MA_plot.pdf")

# --- C. Variance Stabilizing Transformation (VST) ---
vsd <- vst(dds, blind = FALSE)
message("VST transformation complete.")

# --- D. Principal Component Analysis (PCA) ---
pdf("05_DE_analysis/PCA_plot.pdf")
plotPCA(vsd, intgroup="condition") +
  ggtitle("PCA Plot of Samples") +
  theme_bw() +
  coord_fixed()
dev.off()
message("PCA plot saved to 05_DE_analysis/PCA_plot.pdf")

# --- E. Heatmap of top differentially expressed genes ---
top_genes_for_heatmap_df <- res_df %>%
  filter(padj < 0.05) %>%
  arrange(padj) %>%
  top_n(50, wt = abs(log2FoldChange))

if(nrow(top_genes_for_heatmap_df) > 0) {
  top_genes_ids <- rownames(top_genes_for_heatmap_df)
  mat <- assay(vsd)[top_genes_ids, ]
  mat <- mat - rowMeans(mat)

  df_annotation <- as.data.frame(colData[, c("condition")])
  colnames(df_annotation) <- "Condition"
  rownames(df_annotation) <- colnames(mat)

  pdf("05_DE_analysis/heatmap_top_DE_genes.pdf")
  pheatmap(mat, annotation_col = df_annotation,
           show_rownames = FALSE,
           fontsize_row = 8,
           fontsize_col = 10,
           cluster_rows = TRUE,
           cluster_cols = TRUE,
           main = "Heatmap of Top Differentially Expressed Genes",
           color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100))
  dev.off()
  message("Heatmap of top DE genes saved to 05_DE_analysis/heatmap_top_DE_genes.pdf")
} else {
  message("No significant genes found (padj < 0.05 and |log2FC| >= 1) for heatmap plotting.")
}

# --- F. Counts Plot for Top Genes ---
top_5_genes <- head(res_df[order(res_df$padj), "gene"], 5)

if (length(top_5_genes) > 0) {
  pdf("05_DE_analysis/top_gene_counts_plots.pdf")
  for (gene_id in top_5_genes) {
    plotCounts(dds, gene=gene_id, intgroup="condition",
               main=paste0("Normalized Counts for: ", gene_id),
               xlab="Condition",
               col=ifelse(colData(dds)$condition == "WildType", "blue", "red"),
               pch=19, cex=1.2)
  }
  dev.off()
  message("Counts plots for top genes saved to 05_DE_analysis/top_gene_counts_plots.pdf")
} else {
  message("No top genes found to generate individual counts plots.")
}

# --- G. Heatmap of Sample-to-Sample Distances ---
sampleDists <- dist(t(assay(vsd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$condition, vsd$sample, sep=" - ")
colnames(sampleDistMatrix) <- NULL

df_annotation_samples <- as.data.frame(colData[, c("condition")])
colnames(df_annotation_samples) <- "Condition"
rownames(df_annotation_samples) <- colnames(mat)

colors_dist <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pdf("05_DE_analysis/sample_distance_heatmap.pdf")
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors_dist,
         annotation_col=df_annotation_samples,
         main="Sample-to-Sample Distances (VST Transformed)")
dev.off()
message("Sample-to-Sample Distance Heatmap saved to 05_DE_analysis/sample_distance_heatmap.pdf")

# --- H. Histogram of P-values ---
hist_data <- na.omit(res_df$pvalue)

pdf("05_DE_analysis/pvalue_histogram.pdf")
hist(hist_data, breaks=50, col="skyblue", border="white",
     main="Histogram of P-values",
     xlab="P-value",
     ylab="Frequency")
dev.off()
message("P-value Histogram saved to 05_DE_analysis/pvalue_histogram.pdf")

message("Differential Expression Analysis in R complete. Check 05_DE_analysis for results and plots.")
EOF